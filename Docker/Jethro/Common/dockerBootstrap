#!/bin/bash
#
# jethro docker bootstarp script

runBackgroudInit(){
  sleep 5

  if [ ! -z $HADDOP_NAME_NODE_ADDRESS ]
  then
    # altering the core-site configuration
    echo configuring name node to: $HADDOP_NAME_NODE_ADDRESS
    sed s/HADDOP_NAME_NODE_ADDRESS/$HADDOP_NAME_NODE_ADDRESS/ $HADOOP_CONF_DIR/core-site.xml.template > $HADOOP_CONF_DIR/core-site.xml 
  fi

  if [ ! -z $AUTO_ATTACH_INSTANCE_NAME ]
  then

    if [ -z $AUTO_ATTACH_INSTANCE_PATH ]
    then
       echo "AUTO_ATTACH_INSTANCE_PATH cannot be empty!"
       exit 1
    fi
    # Attaching to requested instance
    echo Attaching instance: $AUTO_ATTACH_INSTANCE_NAME
    su - jethro -c "mkdir /home/jethro/$AUTO_ATTACH_INSTANCE_NAME-cache"
    su - jethro -c "JethroAdmin attach-instance $AUTO_ATTACH_INSTANCE_NAME -storage-path=$AUTO_ATTACH_INSTANCE_PATH -cache-path=/home/jethro/$AUTO_ATTACH_INSTANCE_NAME-cache -cache-size=10G"
  fi

  # Restarting all services
  service jethro stop >/dev/null 2>&1
  service jethro start >/dev/null 2>&1

  echo  
  echo "Jethro Docker is up!"
  echo "In order to ssh the container - use the predefined ssh port (see docker inpect commnad to see all mapped ports)."

}

echo configuring jethro docker environment...

runBackgroudInit &

exec /usr/sbin/init 